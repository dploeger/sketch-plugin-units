<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />

    <!-- OpenIconic -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"
    />

    <title>Sketch Units Settings</title>

    <!--<script type="text/JavaScript" src="js/settings-view.js"></script>-->

    <script type="text/JavaScript">
    /* Bridges used by the plugin */

/**
 * Add a new unit to the units table
 * @param {Object} unit New unit object
 * @param {string} unit.unitName Name of unit (is used as an identifier)
 * @param {string} unit.dpi DPI value
 * @param {string} unit.factor Conversion factor
 */
window.addUnit = function(unit) {
  const unitRow = $('<tr class="unitRow"></tr>');
  unitRow.click(() => {
    openEditUnitEditor(unitRow);
  });
  unitRow.css("cursor", "pointer");

  unitRow.data("unitName", unit.unitName);
  unitRow.data("dpi", unit.dpi);
  unitRow.data("factor", unit.factor);

  unitRow.append("<td class=unitName>" + unit.unitName + "</td>");
  unitRow.append("<td class=dpi>" + unit.dpi + "</td>");
  unitRow.append("<td class=factor>" + unit.factor + "</td>");

  $("#unitsTable tbody").append(unitRow);
};

/**
 * Show an error message
 */
window.showErrorMessage = function(message) {
  $("#errorMessage").html(message);
  $("#errorMessage").show();
};

/**
 * Hide the error message alert
 */
window.hideErrorMessage = function() {
  $("#errorMessage").hide();
};

/**
 * UI handling
 */

checkFormValidity = function() {
  return $("input", "#unitEditorForm")
    .toArray()
    .reduce(function(isValid, item) {
      if (item.id === "unitName") {
        var exists = $(".unitRow")
          .toArray()
          .reduce(function(doesNameExist, existingItem) {
            if ($(existingItem).data("unitName") === item.value) {
              doesNameExist = true;
            }
            return doesNameExist;
          }, false);
        if (exists) {
          isValid = false;
          item.setCustomValidity("Name already exists");
        }
      }
      if (!item.checkValidity()) {
        isValid = false;
      }
      return isValid;
    }, true);
};

/**
 * Open the unit editor to add a new unit
 */
openNewUnitEditor = function() {
  $("#editWindow").modal();

  // Remove event triggers on modal hide
  $("#editWindow").on("hidden.bs.modal", function() {
    $("#unitEditorOk").off();
  });

  // reset input fields

  $("#unitName")
    .val("")
    .focus();
  $("#dpi").val("");
  $("#factor").val("");

  // Hide delete button for new units
  $("#unitEditorDelete").hide();

  $("#unitEditorOk").click(function() {
    // Validate form
    var isFormValid = checkFormValidity();
    if (isFormValid === false) {
      // Mimic a form submit to trigger form validation messages
      $('<input type="submit">')
        .hide()
        .appendTo($("#unitEditorForm"))
        .click()
        .remove();
    } else {
      // Add the unit
      window.addUnit({
        unitName: $("#unitName").val(),
        dpi: $("#dpi").val(),
        factor: $("#factor").val()
      });
      $("#editWindow").modal("hide");
    }
  });
};

/**
 * Open the unit editor to modify an existing unit
 * @param {Object} unitRow the table row holding the existing unit
 */
openEditUnitEditor = function(unitRow) {
  $("#editWindow").modal();

  // Remove event triggers on modal hide

  $("#editWindow").on("hidden.bs.modal", function() {
    $("#unitEditorOk").off();
    $("#unitEditorDelete").off();
  });

  // Set input field values
  $("#unitName")
    .val(unitRow.data("unitName"))
    .focus();
  $("#dpi").val(unitRow.data("dpi"));
  $("#factor").val(unitRow.data("factor"));

  // React to delete action
  $("#unitEditorDelete")
    .show()
    .click(function() {
      $("#editWindow").modal("hide");
      $(unitRow).remove();
    });
  $("#unitEditorOk").click(function() {
    // Validate form
    var isFormValid = checkFormValidity();
    if (isFormValid === false) {
      // Mimic a form submit to trigger form validation messages
      $('<input type="submit">')
        .hide()
        .appendTo($("#unitEditorForm"))
        .click()
        .remove();
    } else {
      // Change row to match the edited fields
      unitRow.data("unitName", $("#unitName").val());
      unitRow.data("dpi", $("#dpi").val());
      unitRow.data("factor", $("#factor").val());
      $(".unitName", unitRow).text($("#unitName").val());
      $(".dpi", unitRow).text($("#dpi").val());
      $(".factor", unitRow).text($("#factor").val());
      $("#editWindow").modal("hide");
    }
  });
};

/**
 * Gather all units from the unit table and call the plugin to store them
 */
saveSettings = function() {
  var units = [];
  $(".unitRow")
    .toArray()
    .forEach(function(value) {
      var item = $(value);
      units.push({
        unitName: item.data("unitName"),
        dpi: item.data("dpi"),
        factor: item.data("factor")
      });
    });
  window.postMessage("saveSettings", units);
};

    </script>
  </head>

  <body>
    <div class="modal" tabindex="-1" role="dialog" id="editWindow">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Unit Editor</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="unitEditorForm">
                        <div class="form-group">
                            <label for="unitName">Unit name</label>
                            <input type="text" class="form-control" id="unitName" aria-describedby="nameHelp"
                                placeholder="Enter unit name" required>
                            <small id="nameHelp" class="form-text text-muted">Enter a descriptive name for the unit</small>
                        </div>
                        <div class="form-group">
                            <label for="dpi">DPI</label>
                            <input type="number" class="form-control" id="dpi" aria-describedby="dpiHelp"
                                placeholder="Enter DPI value" required>
                            <small id="dpiHelp" class="form-text text-muted">Enter the DPI that will be used when exporting the element. Usually this is 72 for PDFs or 300 for images.</small>
                        </div>
                        <div class="form-group">
                            <label for="factor">Factor</label>
                            <input type="number" class="form-control" id="factor" aria-describedby="factorHelp"
                                placeholder="Enter factor" required step="0.001"> 
                            <small id="factorHelp" class="form-text text-muted">Enter the multiplication factor that will be used to convert from inch to this unit (e.g. 2.54 for cm)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="unitEditorDelete" class="btn btn-danger" data-dismiss="modal">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" id="unitEditorOk" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid" style="padding:0">
          <div class="modal-content" style="height: 600px">
            <div class="modal-header">
              <h5 class="modal-title">Sketch Units Settings</h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
                onclick="window.postMessage('closeSettings')"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <div id="errorMessage" class="alert alert-danger" role="alert">
                </div>
              <h1>Available units</h1>
              <p>This is the list of available units, that the unit plugin can convert between.</p>
              <p>Every unit needs a DPI value, that is the base of the conversion the plugin is doing and a conversion factor to calculate the unit based on an inch value.</p>
              <div style="width: 100%; height: 200px; overflow-y: scroll">
            <table id="unitsTable" class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Unit</th>
                        <th scope="col">DPI</th>
                        <th scope="col">Factor</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                </table>
                </div>
                <div class="btn-group" role="group" aria-label="Modify Unit list">
                    <button type="button" onclick="openNewUnitEditor()" class="btn btn-secondary"><span class="oi oi-plus" title="+" aria-hidden="true"></span></button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="window.postMessage('closeSettings')">
                    Cancel
                </button>
              <button type="button" class="btn btn-primary" onclick="saveSettings()">
                Ok
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
